import javax.json.*;
import java.io.FileInputStream;
import java.io.FileWriter;
import java.io.InputStream;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.ArrayList;

public class Main {
    public static void main(String[] args) throws Exception {
        Map<String, Object> config = new HashMap<String, Object>();
        InputStream fis = new FileInputStream("person.json");
        JsonReader reader = Json.createReader(fis);
        JsonObject object = reader.readObject();
        ArrayList<Integer> average = new ArrayList<Integer>();
        for(int i = 0; i < object.getJsonArray("students").size(); i++){
            JsonObject holder = (JsonObject) object.getJsonArray("students").get(i);
            holder = holder.getJsonObject("grades");
            Iterator<String> key = holder.keySet().iterator();
            average.add(((holder.getInt(key.next())) + (holder.getInt(key.next())) + (holder.getInt(key.next())))/3);
        }
        int[] rank = new int[average.size()];
        ArrayList<Integer> copy = new ArrayList<>();
        for(int i = 0; i < average.size(); i++){
            copy.add(average.get(i));
        }
        int ranks = 1;
        for(int i = 0; i < copy.size(); i++){
            for(int j = 0; j < copy.size(); j++){
                if(copy.get(i) < copy.get(j))
                    ranks++;
            }
            rank[i] = ranks;
            ranks = 1;
        }
        JsonBuilderFactory factory = Json.createBuilderFactory(config);
        JsonObject updated = (JsonObject) factory.createObjectBuilder().build();
        JsonObject copyed = (JsonObject) factory.createObjectBuilder().build();
        for(int i = 0; i < object.getJsonArray("students").size(); i++){
            JsonObject bin = factory.createObjectBuilder(object.getJsonArray("students").getJsonObject(i))
                    .add("Class Average", average.get(i))
                    .add("Class Rank", rank[i])
                    .build();
            if(i==0) {
                updated = (JsonObject) factory.createObjectBuilder()
                        .add("students", factory.createArrayBuilder()
                                .add(factory.createObjectBuilder(bin)))
                        .build();
            }
            else{
                updated = (JsonObject) factory.createObjectBuilder()
                        .add("students", factory.createArrayBuilder(updated.getJsonArray("students"))
                                .add(factory.createObjectBuilder(copyed))
                                .add(factory.createObjectBuilder(bin)).build())
                        .build();
            }
        }
       FileWriter file = new FileWriter("updated_students.json");
        file.write(updated.toString());
        file.close();
    }
}
